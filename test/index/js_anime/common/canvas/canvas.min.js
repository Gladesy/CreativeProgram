function SetRondomTextureCacheVersion(){TextureCacheVersion="?ver="+Math.floor(1e9*Math.random())}function SetRondomJsonCacheVersion(){var t="00000000"+Math.floor(1e9*Math.random());t=t.slice(-9),JsonCacheVersion="?ver="+t}function SetCallBackOnErrorException(t){g_exception_callback=t}function SetAjaxErrorType(t){g_AjaxErrorType=t}function GetAjaxErrorType(){return g_AjaxErrorType}function ClearAjaxErrorType(){g_AjaxErrorType=""}function SetCanvasScale(t){g_canvasScale=t}function GetCanvasScale(){return g_canvasScale}var ORIGIN_CENTER=0,ORIGIN_LEFT=1,ORIGIN_RIGHT=2,ORIGIN_TOP=3,ORIGIN_BOTTOM=4,POSE_MODE_SRT=0,POSE_MODE_MATRIX=1,PLAY_STATUS_STANDBY=0,PLAY_STATUS_PLAYING=1,PLAYEND_HIDE=0,PLAYEND_PAUSE=1,PLAYEND_LOOP=2,RootImagePath="",RootJsonPath="",INTERVAL_TIME=1e3/30,MAX_FRAME_SKIP=3,CANVAS_SETTING_KEEP_IN_FOCUS=0,CANVAS_SETTING_IGNORE_SCROLL=0,CANVAS_ERRORLOG_UPLOAD=0,CANVAS_ERRORLOG_UPLOAD_REQUEST_URL="",CANVAS_SCALE=1,TextureCacheVersion="?ver=1",JsonCacheVersion="?ver=1",g_exception_callback=null,g_AjaxErrorType="",g_canvasScale=CANVAS_SCALE,TextureLoadProgress,TextureLoadError=!1,Texture=function(){function t(){return this.retry>3?(this.removeEventListener("load",e),this.removeEventListener("error",t),this.retry=-1,void(0!=this.width&&0!=this.height&&0!=this.naturalWidth&&0!=this.naturalHeight||(TextureLoadError=!0,delete i[this.filename]))):void(this.src=RootImagePath+this.filename+TextureCacheVersion+this.retry++)}function e(){0!=this.width&&0!=this.height&&(this.retry=60),t.call(this)}function n(n){this.m_Filename=n,this.m_Image=new Image,this.m_Image.retry=0,this.m_Image.addEventListener("load",e),this.m_Image.addEventListener("error",t);var i=RootImagePath+n;n.match(/\?/i)||(i=RootImagePath+n+TextureCacheVersion),this.m_Image.src=i,this.m_Image.filename=n}var i=new Object;return TextureLoadProgress=function(){var t=0,e=0;for(var n in i)++t,i[n].IsLoaded()&&++e;return 100*e/t},n.prototype.GetImage=function(){return this.m_Image},n.prototype.GetFilename=function(){return this.m_Filename},n.prototype.IsLoaded=function(){return this.m_Image.retry==-1&&(this.IsLoaded=function(){return!0}),!1},n.prototype.IsLoadError=function(){return this.m_Image.retry==-1&&(0==this.m_Image.width||0==this.m_Image.height||0==this.m_Image.naturalWidth||0==this.m_Image.naturalHeight?this.IsLoadError=function(){return!0}:this.IsLoadError=function(){return!1}),!1},n.prototype.GetWidth=function(){return this.m_Image.width},n.prototype.GetHeight=function(){return this.m_Image.height},function(t){return t in i||(i[t]=new n(t)),i[t]}}(),Node=function(){function t(){this.m_ChildNode=new Array,this.m_ParentNode=0,this.m_ParentNodeInstanceName="",this.m_X=0,this.m_Y=0,this.m_Z=0,this.m_Rot=0,this.m_ScaleX=1,this.m_ScaleY=1,this.m_Mat=new Matrix,this.m_MatW=new Matrix,this.MatL=new Matrix,this.ParentMat=new Matrix,this.m_PoseMode=POSE_MODE_SRT,this.m_CompositeOperation="source-over",this.m_Alpha=1,this.m_GlobalAlpha=1}return t.prototype.AddChild=function(t,e){t.DetachFromParent(),t.m_ParentNode=this,"undefined"!=typeof e&&(t.m_ParentNodeInstanceName=e),this.m_ChildNode[this.m_ChildNode.length]=t},t.prototype.AddChildPriority=function(t,e){if(t.DetachFromParent(),t.m_ParentNode=this,"undefined"!=typeof e){t.m_ParentNodeInstanceName=e;var n=this.GetInstancePriority(e);t.SetPriority(n)}this.m_ChildNode[this.m_ChildNode.length]=t},t.prototype.DetachFromParent=function(){if(0!=this.m_ParentNode){for(var t in this.m_ParentNode.m_ChildNode)if(this.m_ParentNode.m_ChildNode[t]==this){this.m_ParentNode.m_ChildNode.splice(t,1);break}this.m_ParentNode=0}},t.prototype.TraversForUpdate=function(t,e){if(!this.m_IsHide){this.m_PoseMode==POSE_MODE_SRT?this.MatL.SetSRT(this.m_ScaleX,this.m_ScaleY,this.m_Rot,this.m_X,this.m_Y):this.MatL=this.m_Mat;var n=this.m_Alpha*e;if(""!=this.m_ParentNodeInstanceName){if(0!=this.m_ParentNode.m_AnimeData){var i=this.m_ParentNode.m_AnimeData.GetInstanceIDByName(this.m_ParentNodeInstanceName),r=this.m_ParentNode.m_AnimeData.GetInstanceMatrixByID(i,this.m_ParentNode.GetTime());this.ParentMat.Mult(r,t),n*=this.m_ParentNode.GetAlpha(this.m_ParentNodeInstanceName,this.m_ParentNode.GetTime())}this.m_MatW.Mult(this.MatL,this.ParentMat)}else this.m_MatW.Mult(this.MatL,t);this.Update(n);var o=this.m_ChildNode;for(var a in o){var s=o[a];s.m_IsHide||s.TraversForUpdate(this.m_MatW,n)}}},t.prototype.AdvanceTime=function(t){for(var e in this.m_ChildNode)this.m_ChildNode[e].AdvanceTime(t)},t.prototype.GetNodeNum=function(t){if("undefined"==typeof t)var t=this;for(var e=1,n=0;n<t.m_ChildNode.length;n++)e+=this.GetNodeNum(t.m_ChildNode[n]);return e},t.prototype.GetShowNodeNum=function(t){if("undefined"==typeof t)var t=this;if(t.m_IsHide)return 0;for(var e=1,n=0;n<t.m_ChildNode.length;++n)e+=this.GetShowNodeNum(t.m_ChildNode[n]);return e},t.prototype.SetHide=function(t){this.m_IsHide=t},t.prototype.IsHide=function(){return this.m_IsHide},t.prototype.Update=function(t){this.m_GlobalAlpha=t},t.prototype.SetPos=function(t,e){this.m_PoseMode=POSE_MODE_SRT,this.m_X=t,this.m_Y=e},t.prototype.GetPos=function(){return[this.m_X,this.m_Y]},t.prototype.SetRotate=function(t){this.m_PoseMode=POSE_MODE_SRT,this.m_Rot=t},t.prototype.SetScale=function(t,e){this.m_PoseMode=POSE_MODE_SRT,this.m_ScaleX=t,this.m_ScaleY=e},t.prototype.SetMatrix=function(t){this.m_PoseMode=POSE_MODE_MATRIX,this.m_Mat=t},t.prototype.SetPriority=function(t){this.m_Z=t},t.prototype.GetPriority=function(){return this.m_Z},t.prototype.SetAlpha=function(t){this.m_Alpha=t},t.prototype.GetAlpha=function(){return this.m_Alpha},t.prototype.CompositeOperation=function(t){this.m_CompositeOperation=t},t.prototype.SetWorldMatrix=function(t){this.m_MatW.Copy(t)},t.prototype.GetDrawObj=function(){return null},t}(),DrawObj=function(){function t(){this.m_IsHide=!1,this.m_W=1,this.m_H=1,this.m_Priority=1e4,this.m_OriginX=ORIGIN_CENTER,this.m_OriginY=ORIGIN_CENTER,this.m_Color="rgb(0, 0, 0)"}return t.prototype=new Node,t.prototype.SetSize=function(t,e){this.m_W=t,this.m_H=e},t.prototype.GetWidth=function(){return this.m_W},t.prototype.GetHeight=function(){return this.m_H},t.prototype.GetLeft=function(){switch(this.m_OriginX){case ORIGIN_LEFT:return 0;case ORIGIN_CENTER:return-this.m_W/2;case ORIGIN_RIGHT:return-this.m_W}return 0},t.prototype.GetRight=function(){switch(this.m_OriginX){case ORIGIN_CENTER:return this.m_W/2;case ORIGIN_LEFT:return this.m_W;case ORIGIN_RIGHT:return 0}return 0},t.prototype.GetTop=function(){switch(this.m_OriginY){case ORIGIN_TOP:return 0;case ORIGIN_CENTER:return-this.m_H/2;case ORIGIN_BOTTOM:return-this.m_H}return 0},t.prototype.GetBottom=function(){switch(this.m_OriginY){case ORIGIN_CENTER:return this.m_H/2;case ORIGIN_TOP:return this.m_H;case ORIGIN_BOTTOM:return 0}return this.m_H},t.prototype.SetOriginType=function(t,e){this.m_OriginX=t,this.m_OriginY=e},t.prototype.GetDrawObj=function(){return this},t}(),Quad=function(){function t(){this.m_MatW=new Matrix}return t.prototype=new DrawObj,t.prototype.SetRGB=function(t,e,n){this.m_Color="rgb("+t+","+e+","+n+")"},t.prototype.Draw=function(t){t.setTransform(1,0,0,1,0,0),t.transform(this.m_MatW.M00,this.m_MatW.M10,this.m_MatW.M01,this.m_MatW.M11,this.m_MatW.M02,this.m_MatW.M12),t.fillStyle=this.m_Color,t.fillRect(this.GetLeft(),this.GetTop(),this.m_W,this.m_H)},t}(),Sprite=function(){function t(){this.m_U0=0,this.m_U1=1,this.m_V0=0,this.m_V1=1,this.m_MatW=new Matrix}return t.prototype=new DrawObj,t.prototype.Draw=function(t){if(this.m_Texture&&0!=this.m_Texture.IsLoaded()&&(t.setTransform(1,0,0,1,0,0),t.transform(this.m_MatW.M00,this.m_MatW.M10,this.m_MatW.M01,this.m_MatW.M11,this.m_MatW.M02,this.m_MatW.M12),0==this.m_Texture.IsLoadError()))try{t.drawImage(this.m_Texture.m_Image,this.m_U0,this.m_V0,this.m_U1,this.m_V1,this.GetLeft(),this.GetTop(),this.m_W,this.m_H)}catch(e){console.log(this.m_Texture.GetFilename()),console.log(e)}},t.prototype.SetTexture=function(t){this.m_Texture=t,this.SetSize(0,0),this.SetTextureUv(this.m_U0,this.m_V0,this.m_U1,this.m_V1)},t.prototype.SetSize=function(t,e){0==t&&0==e?(this.m_W=this.m_Texture.m_Image.width,this.m_H=this.m_Texture.m_Image.height):(this.m_W=Math.round(t),this.m_H=Math.round(e))},t.prototype.SetTextureUv=function(t,e,n,i){var r=this.m_Texture.m_Image.width,o=this.m_Texture.m_Image.height;this.m_U0=Math.round(Clamp(r*Math.abs(t),0,r-1)),this.m_V0=Math.round(Clamp(o*Math.abs(e),0,o-1)),this.m_U1=Math.round(Clamp(Math.max(r*Math.abs(n-t),1),1,r)),this.m_V1=Math.round(Clamp(Math.max(o*Math.abs(i-e),1),1,o))},t}(),Text=function(){function t(t){this.m_Str="",this.m_Font="Arial",this.m_FontSize=16,this.m_FontColor="rgb(255,255,255)",this.m_IsShadow=!1,this.m_FontShadowColor="rgb(0,0,0)",this.m_MaxWidth=0,this.m_LineMargin=2,this.m_IsBold=!1,this.m_MatW=new Matrix}return t.prototype=new DrawObj,t.prototype.Draw=function(t){var e="";1==this.m_IsBold&&(e+="bold "),t.font=e+this.m_FontSize+"px "+this.m_Font;for(var n=this.m_Str.split("<br>"),i=0;i<n.length;++i){var r=t.measureText(n[i]).width,o=.7*this.m_FontSize;if(this.m_MaxWidth>0&&r>this.m_MaxWidth)for(var a=this.m_FontSize-1;a>0;--a){t.font=a+"px "+this.m_Font;var r=t.measureText(n[i]).width;if(r<=this.m_MaxWidth)break}var s=0,m=o+(o+this.m_LineMargin)*i;switch(this.m_OriginX){case ORIGIN_CENTER:s-=r/2;break;case ORIGIN_LEFT:s=0;break;case ORIGIN_RIGHT:s-=r}switch(this.m_OriginY){case ORIGIN_CENTER:m-=(o*n.length+this.m_LineMargin*(n.length-1))/2;break;case ORIGIN_TOP:m=o+(o+this.m_LineMargin)*i;break;case ORIGIN_BOTTOM:m=0}t.setTransform(1,0,0,1,0,0),t.transform(this.m_MatW.M00,this.m_MatW.M10,this.m_MatW.M01,this.m_MatW.M11,this.m_MatW.M02,this.m_MatW.M12),this.m_IsShadow&&(t.fillStyle=this.m_FontShadowColor,t.fillText(n[i],s+1,m+1)),t.fillStyle!=this.m_FontColor&&(t.fillStyle=this.m_FontColor),t.fillText(n[i],s,m)}},t.prototype.SetString=function(t){this.m_Str=String(t)},t.prototype.SetFont=function(t){this.m_Font=t},t.prototype.SetFontSize=function(t){this.m_FontSize=t},t.prototype.SetFontColor=function(t){this.m_FontColor=t},t.prototype.SetBold=function(t){this.m_IsBold=t},t.prototype.SetShadow=function(t){this.m_IsShadow=t},t.prototype.SetShadowColor=function(t){this.m_FontShadowColor=t},t.prototype.SetMaxWidth=function(t){this.m_MaxWidth=t},t.prototype.SetLineMargin=function(t){this.m_LineMargin=t},t}(),g_JsonFromCombinded=new Object,g_JsonFromUncombinded=new Object,LoadCombinedJsonError=!1,LoadJsonError=!1,LoadCombinedJson=function(){function t(t,n){if("undefined"!=typeof n&&n&&t in e&&delete e[t],g_JSONLoader.IsLoadError(t)&&t in e&&delete e[t],t in e){if(e[t]==-1)return!1;if(e[t]>0)return!0}e[t]=-1;var i=!0;return g_JSONLoader.Regist(t,i),!1}var e=new Object;return t}(),LawJsonLoadProgress,AnimeLawData=function(){function t(t){this.m_JsonFileName=t,this.m_AnimeTableRequest=!1,this.m_AnimeTable=0,this.m_IsCombinded=!0}var e=new Object;return LawJsonLoadProgress=function(){var t=0,n=0;for(var i in e)++t,e[i].IsLoaded()?++n:console.log("filename : "+i);return 100*n/t},t.prototype.GetAnimeTable=function(){return this.m_AnimeTable},t.prototype.GetVersion=function(){return"undefined"==typeof this.m_AnimeTable.Version?0:this.m_AnimeTable.Version},t.prototype.Load=function(t,e,n){if(1!=this.m_AnimeTableRequest||0!=g_JSONLoader.IsLoadError(this.m_JsonFileName)){if(this.m_AnimeTableRequest=!0,this.m_TextureFilePath=e,this.m_OverrideTextureArray=n,"undefined"!=typeof t)return this.m_AnimeTable=t,this.LoadTexture(),void this.Init();this.m_IsCombinded=!1;var i=!1;g_JSONLoader.Regist(this.m_JsonFileName,i)}},t.prototype.IsLoaded=function(){if(0==this.m_IsCombinded){if(!g_JSONLoader.IsLoaded(this.m_JsonFileName))return!1;this.m_AnimeTable=g_JSONLoader.GetData(this.m_JsonFileName),this.LoadTexture(),this.Init()}var t=this.GetAnimeTable();if("undefined"==typeof t)return!1;if(0==t)return!1;if(t.Version<4&&t.m_PreCalcedFrame<t.m_EndTime)return!1;for(var e in t.Instance){var n=t.Instance[e],i=this.GetTextureFileName(n);if(""!==i&&0==Texture(i).IsLoaded())return!1}return this.IsLoaded=function(){return!0},!0},t.prototype.LoadTexture=function(){var t=this.GetAnimeTable();for(var e in t.Instance){var n=t.Instance[e],i=this.GetTextureFileName(n);""!==i&&Texture(i)}},t.prototype.GetTextureFileName=function(t){var e=t.ID;if("undefined"!=typeof this.m_OverrideTextureArray[e])return this.m_OverrideTextureArray[e];var n=t.Contents.TextureFileName;return""!==n?this.m_TextureFilePath+n:""},t.prototype.Init=function(){var t=this.GetAnimeTable();if("undefined"==typeof t.Version&&(t.Version=0),t.m_PreCalcedFrame=0,t.m_SpriteStatus=new Array,t.m_DummyInstanceStatus=new Array,"undefined"!=typeof t){this.SpriteNum=0;for(var e=0;e<t.Instance.length;e++){var n=t.Instance[e];if(""===n.Contents.TextureFileName)if("Dummy"!=n.Contents.Type){var i=!1;switch(n.Contents.Name){case"DeleteFrame":i=!0,t.m_EndMode=PLAYEND_HIDE;break;case"EndFrame":i=!0,t.m_EndMode=PLAYEND_PAUSE;break;case"LoopFrame":i=!0,t.m_EndMode=PLAYEND_LOOP}if(1==i){var r=0;if(t.Version>=4)for(var o in n.Contents.Animation){r=Math.floor(o);break}else alert("v < 4"),r=n.Contents.Animation[0].Frame;t.m_EndTime=r}}else t.m_DummyInstanceStatus[n.ID]=new Array;else n.SpriteID=this.SpriteNum,this.SpriteNum++,t.m_SpriteStatus[n.SpriteID]={InstanceID:n.ID,AnimeStatus:new Array}}for(var o=0;o<this.SpriteNum;o++)for(var a=1;a<=t.m_EndTime;a++)t.m_SpriteStatus[o].AnimeStatus[a]={IsHide:!0};if(t.Version<4)for(var a=this.m_PreCalcedFrame+1;a<=t.m_EndTime;++a)this.PreCalcExec(t,a)}},t.prototype.TraversForPreCalc=function(t,e,n,i,r,o){var a=new Matrix;a.Copy(r);for(var s=0;s<t.Instance.length;++s){var m=t.Instance[s];if(m.ID==e){m.Mat=new Matrix,m.Alpha=o,m.IsHide=!0,m.AddBlend=!1,m.Uv=[0,0,0,0],i-=m.Contents.OffsetFrame;var h=(i-1)%m.Contents.TotalFrames,_=0;if(m.Contents.Animation.length>0)for(var u=4;u>=0&&(_=Math.floor((m.Contents.Animation.length-1)*u/5),!(h>m.Contents.Animation[_].Frame-1));u--);for(var u=_;u<m.Contents.Animation.length;u++){var d=m.Contents.Animation[u];if(d.Frame-1==h){var p=[0,0],f=0,c=[1,1],l=[1,1],y=[0,0,0,0],I=1,S=!1,r=new Matrix;if(0!=d.Status.CallFrame)for(var A=0;A<m.Contents.Animation.length;A++)if(m.Contents.Animation[A].Frame==d.Status.CallFrame){RefAnimation=m.Contents.Animation[A];var T=RefAnimation.Status;p=T.Position,f=T.Rotate,c=T.Scale,l=T.Size,I=T.Alpha,S=T.AddBlend,"undefined"!=typeof T.Uv&&(y=T.Uv),"undefined"!=typeof T.Matrix&&(r=T.Matrix);break}var v=d.Status;if("undefined"!=typeof v.Position&&(p=v.Position),"undefined"!=typeof v.Rotate&&(f=v.Rotate),"undefined"!=typeof v.Scale&&(c=v.Scale),"undefined"!=typeof v.Size&&(l=v.Size),"undefined"!=typeof v.Alpha&&(I=v.Alpha),"undefined"!=typeof v.AddBlend&&(S=v.AddBlend),"undefined"!=typeof v.Uv&&(y=v.Uv),"undefined"!=typeof v.Matrix&&(r=v.Matrix),t.Version>=4)a.Set(r[0],r[1],r[2],r[3],r[4],r[5]);else{var M=new Matrix;M.SetSRT(c[0],c[1],f,p[0],p[1]),a.Mult(M,a)}if(m.IsHide=!1,m.Alpha=o*I,""!==m.Contents.TextureFileName){var g=new Matrix;g.SetScale(l[0],l[1]),m.Mat.Mult(g,a),m.AddBlend=S,m.Uv=y,t.m_SpriteStatus[m.SpriteID].AnimeStatus[n]={IsHide:!1,Mat:m.Mat,Priority:m.Contents.Priority,Alpha:m.Alpha,AddBlend:m.AddBlend,Uv:m.Uv}}"Dummy"==m.Contents.Type&&(t.m_DummyInstanceStatus[m.ID][n]={Mat:a,Alpha:m.Alpha});break}}if(0==m.Contents.Animation.length&&(m.IsHide=!1),0==m.IsHide)for(var A in m.Contents.ChildInstanceIndex){var C=m.Contents.ChildInstanceIndex[A];0!=C&&this.TraversForPreCalc(t,C,n,i,a,m.Alpha)}break}}},t.prototype.PreCalcExec=function(t,e){for(var n=new Matrix,i=0;i<t.Instance.length;++i){var r=t.Instance[i];0==r.Contents.ParentInstanceIndex&&this.TraversForPreCalc(t,r.ID,e,e,n,1)}t.m_PreCalcedFrame=e},function(n){return n in e||(e[n]=new t(n)),e[n]}}(),AnimeData=function(){function t(t,e,n){this.m_JsonFileName=t,this.m_TextureFilePath=e,this.m_OverrideTextureArray=new Array,this.m_IsCombined="undefined"!=typeof n&&n,this.Mat=new Matrix,this.m_memoize={}}return t.prototype.Load=function(t){this.m_IsCombined||AnimeLawData(this.m_JsonFileName).Load(t,this.m_TextureFilePath,this.m_OverrideTextureArray)},t.prototype.IsLoaded=function(){if(1==this.m_IsCombined){if("undefined"==typeof g_JsonFromCombinded[this.m_JsonFileName])return!1;AnimeLawData(this.m_JsonFileName).Load(g_JsonFromCombinded[this.m_JsonFileName],this.m_TextureFilePath,this.m_OverrideTextureArray)}return AnimeLawData(this.m_JsonFileName).IsLoaded()},t.prototype.IsJsonFileLoaded=function(){return"undefined"!=typeof g_JsonFromCombinded[this.m_JsonFileName]},t.prototype.GetJsonFileName=function(){return this.m_JsonFileName},t.prototype.ChangeTextureFileName=function(t,e){this.m_OverrideTextureArray[t]=e},t.prototype.ChangeTexture=function(t,e){this.m_OverrideTextureArray[t]=e.GetFilename()},t.prototype.GetTextureFileNames=function(){var t=new Array,e=this.GetAnimeTable();for(var n in e.Instance){var i=e.Instance[n];""!=i.Contents.TextureFileName&&(t[t.length]=i.Contents.TextureFileName)}return t},t.prototype.LoadTexture=function(){for(var t=this.GetAnimeTable(),e=0;e<t.Instance.length;e++)if("undefined"!=typeof t.Instance[e]){var n=t.Instance[e],i=this.GetTextureFileName(n);""!==i&&Texture(i)}},t.prototype.GetTextureFileName=function(t){var e=t.ID;if("undefined"!=typeof this.m_OverrideTextureArray[e])return this.m_OverrideTextureArray[e];var n=t.Contents.TextureFileName;return""!==n?this.m_TextureFilePath+n:""},t.prototype.GetTextureFileNameByInstanceID=function(t){for(var e=this.GetAnimeTable(),n=0;n<e.Instance.length;n++)if("undefined"!=typeof e.Instance[n]){var i=e.Instance[n];if(i.ID==t)return this.GetTextureFileName(i)}},t.prototype.GetAnimeTable=function(){return this.m_Anitable||(this.m_Anitable=AnimeLawData(this.m_JsonFileName).GetAnimeTable()),this.m_Anitable},t.prototype.GetInstanceIDByName=function(t){if(this.m_memoize[t])return this.m_memoize[t];for(var e=this.GetAnimeTable(),n=e.Instance.length;n--;)if("undefined"!=typeof e.Instance[n]){var i=e.Instance[n];if(i.Contents.Name==t)return this.m_memoize[t]=i.ID,i.ID}},t.prototype.GetInstanceByName=function(t){for(var e=this.GetAnimeTable(),n=0;n<e.Instance.length;n++)if("undefined"!=typeof e.Instance[n]){var i=e.Instance[n];if(i.Contents.Name==t)return i}},t.prototype.GetInstanceByID=function(t){for(var e=this.GetAnimeTable(),n=0;n<e.Instance.length;n++)if("undefined"!=typeof e.Instance[n]){var i=e.Instance[n];if(i.ID==t)return i}},t.prototype.GetInstanceSizeByID=function(t,e){var n=(this.GetAnimeTable(),new Array),i=this.GetInstanceByID(t);return"undefined"!=typeof i.Contents.Animation[e]?(i.Contents.Animation[e].CallFrame>0?frame=i.Contents.Animation[e].CallFrame:frame=e,n=i.Contents.Animation[frame].Size):n=[0,0],n},t.prototype.GetInstanceMatrixByID=function(t,e){var n=this.GetAnimeTable();if(n.Version>=4){var i=this.GetInstanceByID(t);if("undefined"==typeof i)return this.Mat.Zero(),this.Mat;var r=i.Contents.Animation[e];if("undefined"==typeof r)return this.Mat.Zero(),this.Mat;if("undefined"!=typeof r.Matrix){var o=r.Matrix;this.Mat.Set(o[0],o[1],o[2],o[3],o[4],o[5])}else if(r.CallFrame>0){var a=i.Contents.Animation[r.CallFrame];if("undefined"!=typeof a.Matrix){var o=a.Matrix;this.Mat.Set(o[0],o[1],o[2],o[3],o[4],o[5])}}return this.Mat}return"undefined"==typeof n.m_DummyInstanceStatus[t]||"undefined"==typeof n.m_DummyInstanceStatus[t][e]?(this.Mat.Zero(),this.Mat):n.m_DummyInstanceStatus[t][e].Mat},t.prototype.GetInstancePriorityByID=function(t){var e=this.GetInstanceByID(t);return e.Contents.Priority/1e4},t.prototype.GetAlpha=function(t,e){var n=this.GetAnimeTable();return"undefined"==typeof n.m_DummyInstanceStatus[t]||"undefined"==typeof n.m_DummyInstanceStatus[t][e]?0:n.m_DummyInstanceStatus[t][e].Alpha},t}(),AnimeObj=function(){function t(){this.m_ParentNode=0,this.m_ChildNode=new Array,this.m_AnimeData=0,this.m_SpriteArray=new Array,this.m_EndMode=PLAYEND_LOOP,this.m_Time=1,this.m_BeginTime=1,this.m_EndTime=1,this.m_PlaySpeed=1,this.m_IsPlayFinished=!1,this.m_MatW=new Matrix,this.Mat=new Matrix}return t.prototype=new Node,t.prototype.SetAnimeData=function(t){if("undefined"==typeof t)return!1;this.m_AnimeData=t,this.m_SpriteArray=new Array,this.m_Time=1,this.m_BeginTime=1,this.m_EndTime=1;for(var e=this.m_AnimeData.GetAnimeTable(),n=0;n<e.Instance.length;n++)if("undefined"!=typeof e.Instance[n]){var i=e.Instance[n],r=i.Contents.TextureFileName;""!==r&&(i.SpriteID=this.m_SpriteArray.length,this.m_SpriteArray.push(new Sprite)),this.m_EndMode=e.m_EndMode,this.m_EndTime=e.m_EndTime}},t.prototype.GetEndTime=function(){return this.m_EndTime},t.prototype.Play=function(t){this.m_IsPlayFinished=!1,"undefined"!=typeof t&&(this.m_Time=t),this.SetHide(!1)},t.prototype.Stop=function(){this.m_IsPlayFinished=!0,this.SetHide(!0)},t.prototype.Pause=function(){this.SetPlaySpeed(0)},t.prototype.SetPlaySpeed=function(t){this.m_PlaySpeed=t},t.prototype.SetTime=function(t){this.m_Time=t},t.prototype.SetBeginTime=function(t){this.m_BeginTime=t},t.prototype.SetEndTime=function(t){this.m_EndTime=t},t.prototype.GetTime=function(){return this.m_Time},t.prototype.IsPlayFinished=function(){return this.m_IsPlayFinished},t.prototype.SetEndHide=function(){this.m_EndMode=PLAYEND_HIDE},t.prototype.SetEndPause=function(){this.m_EndMode=PLAYEND_PAUSE},t.prototype.SetEndLoop=function(){this.m_EndMode=PLAYEND_LOOP},t.prototype.SetLoop=function(t,e){this.m_BeginTime=t,this.m_EndTime=e,this.m_EndMode=PLAYEND_LOOP},t.prototype.GetInstanceSize=function(t){return this.m_AnimeData.GetInstanceSizeByID(t,this.GetTime())},t.prototype.GetInstanceMatrix=function(t){var e=this.m_AnimeData.GetInstanceIDByName(t);return this.m_AnimeData.GetInstanceMatrixByID(e,this.GetTime())},t.prototype.GetInstancePriority=function(t){var e=this.m_AnimeData.GetInstanceIDByName(t);return this.m_AnimeData.GetInstancePriorityByID(e)},t.prototype.AdvanceTime=function(t){if(this.m_Time+=this.m_PlaySpeed*t,this.m_Time<1&&(this.m_Time=1),this.m_Time>=this.m_EndTime+1)switch(this.m_IsPlayFinished=!0,this.m_EndMode){case PLAYEND_HIDE:for(var e=0;e<this.m_SpriteArray.length;++e)this.m_SpriteArray[e].SetHide(!0);this.SetHide(!0),this.m_Time=this.m_EndTime;break;case PLAYEND_PAUSE:this.m_Time=this.m_EndTime;break;case PLAYEND_LOOP:this.m_Time=this.m_BeginTime}for(var e in this.m_ChildNode)this.m_ChildNode[e].AdvanceTime(t)},t.prototype.SetSpriteStatus=function(t,e,n,i,r){var o=(this.m_AnimeData.GetAnimeTable(),this.m_SpriteArray[t]);if("undefined"!=typeof e.Size&&o.SetSize(e.Size[0],e.Size[1]),"undefined"!=typeof e.Matrix&&(this.Mat.Set(e.Matrix[0],e.Matrix[1],e.Matrix[2],e.Matrix[3],e.Matrix[4],e.Matrix[5]),this.Mat.Mult(this.Mat,this.m_MatW),o.SetWorldMatrix(this.Mat)),"undefined"!=typeof e.Alpha&&(o.m_GlobalAlpha=e.Alpha*i),"undefined"!=typeof e.AddBlend&&o.CompositeOperation(e.AddBlend?"lighter":"source-over"),"undefined"!=typeof e.Uv){var a=r.GetWidth(),s=r.GetHeight();0==e.Uv[2]&&(e.Uv[0]=0,e.Uv[2]=a),0==e.Uv[3]&&(e.Uv[1]=0,e.Uv[3]=s);var m=e.Uv[0]/a,h=e.Uv[1]/s,_=(e.Uv[0]+e.Uv[2])/a,u=(e.Uv[1]+e.Uv[3])/s;o.SetTextureUv(m,h,_,u)}},t.prototype.Update=function(t){if(!this.m_IsHide&&0!=this.m_AnimeData)for(var e=this.m_AnimeData.GetAnimeTable(),n=Math.floor(this.m_Time),i=0;i<this.m_SpriteArray.length;++i){var r=this.m_SpriteArray[i];if("undefined"!=typeof e.m_SpriteStatus&&0!=e.m_SpriteStatus[i].AnimeStatus.length){var o=e.m_SpriteStatus[i],a=this.m_AnimeData.GetTextureFileNameByInstanceID(o.InstanceID),s=Texture(a);if(r.SetTexture(s),e.Version>=4){for(var m=0,h=0;h<e.Instance.length;++h)if("undefined"!=typeof e.Instance[h]&&o.InstanceID==e.Instance[h].ID){m=e.Instance[h];break}if(0==m)continue;var _=m.Contents.Animation[n],u="undefined"==typeof _;if(r.SetHide(u),1==u)continue;if(r.SetPriority(this.m_Z+m.Contents.Priority/1e4),r.SetSize(1,1),r.SetAlpha(1),r.CompositeOperation("source-over"),r.SetTextureUv(0,0,1,1),_.CallFrame>0){var d=_.CallFrame;this.SetSpriteStatus(i,m.Contents.Animation[d],d,t,s)}this.SetSpriteStatus(i,_,n,t,s),this.TextureBokeTaisaku(r)}else{var _=e.m_SpriteStatus[i].AnimeStatus[n];if("undefined"!=typeof _&&(r.SetHide(_.IsHide),1!=_.IsHide)){this.Mat.Mult(_.Mat,this.m_MatW),r.SetWorldMatrix(this.Mat),r.SetPriority(this.m_Z+_.Priority/1e4);var p=_.Alpha*t;r.SetAlpha(p),r.CompositeOperation(_.AddBlend?"lighter":"source-over");var f=s.GetWidth(),c=s.GetHeight();0==_.Uv[2]&&(_.Uv[0]=0,_.Uv[2]=f),0==_.Uv[3]&&(_.Uv[1]=0,_.Uv[3]=c);var l=_.Uv[0]/f,y=_.Uv[1]/c,I=(_.Uv[0]+_.Uv[2])/f,S=(_.Uv[1]+_.Uv[3])/c;r.SetTextureUv(l,y,I,S),this.TextureBokeTaisaku(r)}}}}},t.prototype.TextureBokeTaisaku=function(t){if("undefined"!=typeof t.m_MatW&&0==t.m_MatW.M10&&0==t.m_MatW.M01){var e=Math.abs(t.m_MatW.M00*t.m_ScaleX*t.GetWidth()),n=Math.abs(t.m_MatW.M11*t.m_ScaleY*t.GetHeight()),i=t.m_MatW.M02,r=t.m_MatW.M12,o=i-e/2,a=r-n/2,s=o-o;t.m_MatW.M02-=s,t.m_MatW.M02+=s>.5?1:0;var m=a-a;t.m_MatW.M12-=m,t.m_MatW.M12+=m>.5?1:0}},t.prototype.GetAlpha=function(t,e){var n=1;if("undefined"==typeof t||""==t||"undefined"==typeof e)return n;var i=this.m_AnimeData.GetAnimeTable();if(i.Version>=4){var r=this.m_AnimeData.GetInstanceByName(t);if("undefined"==typeof r)return 0;var o=r.Contents.Animation[e];if("undefined"==typeof o)return 0;var a=1;if("undefined"!=typeof o.Alpha)a=o.Alpha;else if(o.CallFrame>0){var s=r.Contents.Animation[o.CallFrame];"undefined"!=typeof s.Alpha&&(a=s.Alpha)}n*=a}else{var m=this.m_AnimeData.GetInstanceIDByName(t);n*=this.m_AnimeData.GetAlpha(m,e)}return n},t.prototype.GetDrawObj=function(){return this.m_SpriteArray},t.prototype.GetInstancePos=function(t,e){var n={wx:0,wy:0,lx:0,ly:0},i=this.m_AnimeData.GetInstanceByName(t);if("undefined"==typeof i)return n;var r=i.Contents.Animation[e];return"undefined"==typeof r?n:{wx:this.m_MatW.M02+r.Matrix[4],wy:this.m_MatW.M12+r.Matrix[5],lx:this.m_MatW.M02,ly:this.m_MatW.M12}},t.prototype.GetInstanceSizeofFrame=function(t,e){var n={w:0,h:0},i=this.m_AnimeData.GetInstanceByName(t);if("undefined"==typeof i)return n;var r=i.Contents.Animation[e];return"undefined"==typeof r?n:{w:r.Size[0],h:r.Size[1]}},t}(),Renderer=function(){function t(){}return t.prototype.AddSceneGraphRoot=function(t){this.m_RootNode=t},t.prototype.TraversSceneGraphForUpdate=function(){var t=new Matrix;this.m_RootNode.TraversForUpdate(t,1)},t.prototype.TraversSceneGraphForAdvanceTime=function(t){this.m_RootNode.AdvanceTime(t)},t.prototype.TraversSceneGraphForRendering=function(t,e){if(e=e||new Array,t.m_IsHide)return e;for(var n=0;n<t.m_ChildNode.length;++n)e=this.TraversSceneGraphForRendering(t.m_ChildNode[n],e);var i=t.GetDrawObj();if(i)if(i.m_IsHide===!1)e.push(i);else for(var n=0;n<i.length;++n)i[n].m_IsHide||e.push(i[n]);return e},t.prototype.Render=function(t,e){e.save();for(var n=0;n<t.length;++n){var i=t[n];!i||i.m_Alpha<.01||(e.globalCompositeOperation!=i.m_CompositeOperation&&(e.globalCompositeOperation=i.m_CompositeOperation),e.globalAlpha!=i.m_GlobalAlpha&&(e.globalAlpha=i.m_GlobalAlpha<0?0:i.m_GlobalAlpha>1?1:i.m_GlobalAlpha),i.Draw(e))}e.restore(),e.globalCompositeOperation="source-over"},t.prototype.RenderSceneGraph=function(){this.TraversSceneGraphForUpdate();var t=this.TraversSceneGraphForRendering(this.m_RootNode);return t.sort(function(t,e){return t.m_Z-e.m_Z}),t},t}(),JSONLoader=function(){function t(){this.m_TaskList=[],this.m_ExecTbl=[]}var e=4,n=new Object,i=new Object,r=new Object,o=new Object;return t.prototype.GetLoadProgress=function(){var t=0,e=0;for(Filename in n)++t,n[Filename]!=-1&&++e;return 100*e/t},t.prototype.Update=function(){if(this.m_TaskList.length>0&&this.m_ExecTbl.length<e){var t=this.m_TaskList.pop();this.m_ExecTbl.push(t),this.Load(t)}},t.prototype.Regist=function(t,e){for(var i in this.m_TaskList)if(this.m_TaskList[i]==t)return;n[t]=!1,r[t]=-1,o[t]=e,this.m_TaskList.push(t)},t.prototype.Unregist=function(t){for(var e in this.m_ExecTbl)this.m_ExecTbl[e]==t&&this.m_ExecTbl.splice(e,1)},t.prototype.Load=function(t){delete i[t],$.ajax({type:"get",dataType:"text",retryCnt:0,parseError:!1,timeout:6e3,url:RootJsonPath+t+JsonCacheVersion,async:!0,success:function(e){try{var a=JSON.parse(e);if(o[t])for(var s in a){var m=a[s];g_JsonFromCombinded[m.Filename]=m.Data}else g_JsonFromUncombinded[t]=a;if(n[t]=!0,g_JSONLoader.Unregist(t),OutputLog("success <- "+t),CANVAS_ERRORLOG_UPLOAD&&1==r[t]){var h="success : "+RootJsonPath+t+JsonCacheVersion+this.retryCnt+"\n";$.ajax({type:"post",dataType:"text",data:"error="+h,url:"?c=Error&f=outputLog",async:!0,success:function(t,e){}})}}catch(_){if(CANVAS_ERRORLOG_UPLOAD){r[t]=!0,OutputLog("Parsing combined json failed : "+RootJsonPath+t+JsonCacheVersion+this.retryCnt+" "+_);var h="Parsing combined json failed : "+RootJsonPath+t+JsonCacheVersion+this.retryCnt+" "+_+"\n";$.ajax({type:"post",dataType:"text",data:"error="+h,url:"?c=Error&f=outputLog",async:!0,success:function(t,e){}})}this.retryCnt++<3?(this.url=RootJsonPath+t+JsonCacheVersion+this.retryCnt,$.ajax(this)):(o[t]?(SetAjaxErrorType("A1"),LoadCombinedJsonError=!0):(SetAjaxErrorType("A3"),LoadJsonError=!0),i[t]=!0,delete n[t],g_JSONLoader.Unregist(t))}},error:function(e,r,a){OutputLog("error <- "+t),this.retryCnt++<3?(this.url=RootJsonPath+t+JsonCacheVersion+this.retryCnt,$.ajax(this)):(o[t]?(SetAjaxErrorType("A2"),"timeout"==r&&SetAjaxErrorType("A5[timeout]"),LoadCombinedJsonError=!0):(SetAjaxErrorType("A4"),"timeout"==r&&SetAjaxErrorType("A6[timeout]"),LoadJsonError=!0),i[t]=!0,delete n[t],g_JSONLoader.Unregist(t))}})},t.prototype.IsLoaded=function(t){return t in n&&n[t]},t.prototype.IsLoadError=function(t){return t in i&&i[t]},t.prototype.GetData=function(t){return t in n&&t in g_JsonFromUncombinded?g_JsonFromUncombinded[t]:null},t}(),g_JSONLoader=new JSONLoader,App=function(){function t(){this.m_Pd=new PointingDevice,this.m_EntityManager=new EntityManager,this.m_Renderer=new Renderer,this.m_SceneBeginTime=(new Date).getTime(),this.m_Fps=0,this.m_AdvanceTime=0,this.carry=0,e=this}var e;return t.prototype.Init=function(){"undefined"!=typeof this.m_InitDesc.JsonCacheVersion&&(JsonCacheVersion="?"+this.m_InitDesc.JsonCacheVersion),"undefined"!=typeof this.m_InitDesc.TextureCacheVersion&&(TextureCacheVersion="?"+this.m_InitDesc.TextureCacheVersion),"undefined"!=typeof this.m_InitDesc.RootImagePath&&(RootImagePath=this.m_InitDesc.RootImagePath),"undefined"!=typeof this.m_InitDesc.RootJsonPath&&(RootJsonPath=this.m_InitDesc.RootJsonPath),this.m_Canvas=document.getElementById(this.m_InitDesc.Canvas);for(var t=0;t<1;++t)this.m_Context=this.m_Canvas.getContext("2d"),this.m_Context.fillStyle="rgb(0, 0, 0)",this.m_Context.fillRect(0,0,this.m_Canvas.width,this.m_Canvas.height);this.m_Pd.Init(this.m_Canvas),this.m_Scene=new this.m_InitDesc.BootScene,this.m_Scene.Init()},t.prototype.Update=function(t){this.m_AdvanceTime=t,this.m_Renderer.TraversSceneGraphForAdvanceTime(t),this.m_EntityManager.Update(),this.m_Scene.Update(t),this.m_DrawObjectArray=this.m_Renderer.RenderSceneGraph(this.m_Context),g_JSONLoader.Update()},t.prototype.Draw=function(){this.m_DrawObjectArray&&(this.m_Renderer.Render(this.m_DrawObjectArray,this.m_Context),this.m_InitDesc.ShowStatus&&Print("[SKIP] "+this.skip+" [FPS] "+Math.floor(this.m_Fps)+" [F] "+this.diff),"undefined"!=typeof RenderPrint&&RenderPrint(this.m_Context))},t.prototype.Interval=function(t){this.m_Pd.Begin(this.m_SceneBeginTime),BeginPrint(),this.Update(t+1),this.Draw(),this.m_Pd.End()},INTERVAL_TIME=33,t.prototype.Animate=function(){var t=(new Date).getTime(),n=t-e.m_SceneBeginTime;if(n>=INTERVAL_TIME){e.m_SceneBeginTime=t;var i=n/INTERVAL_TIME-1+e.carry,r=Math.min(Math.floor(i),MAX_FRAME_SKIP);e.carry=Math.min(i-r,MAX_FRAME_SKIP),e.m_SceneBeginTime%3==0&&(e.skip=r,e.diff=n,e.m_Fps=1e3/n);try{e.Interval(r)}catch(o){return void e.ErrorThrown(o)}}requestAnimationFrame(e.Animate)},t.prototype.Exec=function(t){try{window.scrollTo(0,1),CANVAS_SETTING_KEEP_IN_FOCUS&&setInterval(function(){window.scrollTo(0,1)},1e3),this.m_InitDesc=t,this.Init(),this.Animate()}catch(e){this.ErrorThrown(e)}},t.prototype.GetPointingDevice=function(){return this.m_Pd},t.prototype.SetAllowScrollRange=function(t,e,n,i){this.m_Pd.AllowScrollRange(t,e,n,i)},t.prototype.AddSceneGraphRoot=function(t){
this.m_Renderer.AddSceneGraphRoot(t,0)},t.prototype.GetAdvanceTime=function(){return this.m_AdvanceTime},t.prototype.ErrorThrown=function(t){var e={Info:"",Sequence:"",dataArray:"",DataArray:"",GameStatus:""};if("undefined"!=typeof t&&(e.Info="例外が発生しました :"+t.message+"\n"+t.stack+"\n",t.fileName&&t.lineNumber&&(e.Info+="\nファイル:"+t.fileName+", 行:"+t.lineNumber)),CANVAS_ERRORLOG_UPLOAD){"undefined"!=typeof this.m_Scene&&(e.Sequence+="Sequence:"+this.m_Scene.m_Sequence+"\n");var n=window.btoa(encodeURIComponent(JSON.stringify(e)));$.ajax({type:"post",dataType:"text",data:"error="+n,url:CANVAS_ERRORLOG_UPLOAD_REQUEST_URL,async:!1,success:function(t,e){}})}console.log(e),null!=g_exception_callback&&g_exception_callback()},t}();window.requestAnimationFrame=function(){return function(t){window.setTimeout(t,1)}}();var dumpJson=function(t,e){var n={ksort:!1,indent:!1,funcsrc:!1,undefined2str:!1,maxDepth:10};for(var i in e)n[i]=e[i];var r=parseInt(n.maxDepth);n.maxDepth=r>0?r<100?r:100:1;var o=n.indent?function(t){for(var e="\n",n=0;n<=t;n++)e+="  ";return e}:function(){return""},a=[[/\\/g,"\\\\"],[/\n/g,"\\n"],[/\r/g,"\\r"],[/\t/g,"\\t"],[/(")/g,"\\$1"]],s=function(t){for(var e=0;e<a.length;e++)t=t.replace.apply(t,a[e]);return t},m=function(t,e){if(e>=n.maxDepth)throw"depth "+n.maxDepth+" orver error.";if(null===t)return"null";switch(typeof t){case"undefined":return n.undefined2str?'"undefined"':"null";case"boolean":return t?"true":"false";case"function":t=n.funcsrc?t.toSource():"function()";case"string":return'"'+s(t)+'"';case"object":var i=[];if(t instanceof Array){for(var r=0;r<t.length;r++)i.push(m(t[r],e+1));return"["+o(e)+i.join(","+o(e))+o(e-1)+"]"}var a=[];for(var h in t)a.push(h);n.ksort&&a.sort();for(var r=0;r<a.length;r++)i.push(m(a[r],e+1)+":"+m(t[a[r]],e+1));return"{"+o(e)+i.join(","+o(e))+o(e-1)+"}"}return t};return m(t,0)};